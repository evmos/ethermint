from concurrent.futures import ThreadPoolExecutor, as_completed

import requests
from pystarport import ports

from .utils import CONTRACTS, deploy_contract


def call(port, params):
    url = f"http://127.0.0.1:{ports.evmrpc_port(port)}"
    return requests.post(url, json=params)


def test_call(ethermint):
    _, res = deploy_contract(ethermint.w3, CONTRACTS["TestExploitContract"])
    param = {
        "jsonrpc": "2.0",
        "method": "eth_call",
        "params": [{
            "data": "0x5e67164c",
            "to": res["contractAddress"],
        }, "latest"],
        "id": 1,
    }
    params = []
    limit = 10
    for is_concurrent in [True, False]:
        if is_concurrent:
            with ThreadPoolExecutor(limit) as executor:
                tasks = [
                    executor.submit(
                        call, ethermint.base_port(0), params
                    ) for _ in range(0, limit)
                ]
                results = [future.result() for future in as_completed(tasks)]
                assert len(results) == limit
        else:
            for _ in range(1, limit):
                params.append(param)
            rsp = call(ethermint.base_port(0), params)
            assert rsp.status_code == 200
